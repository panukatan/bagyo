---
title: "Introduction to bagyo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to bagyo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo = FALSE}
library(bagyo)
```

The `bagyo` package contains the `cyclones` dataset. This dataset was taken from annual reports on Philippine tropical cyclones prepared and released by [PAGASA](https://www.pagasa.dost.gov.ph/) at its [website](https://www.pagasa.dost.gov.ph/tropical-cyclone/publications/annual-report) in PDF format.

Because the reports are in PDF format and the information described above are in tables within the documents, scripts for scraping the desired data were developed and implemented to arrive at the `cyclones` dataset. The data scraping script can be viewed [here](https://github.com/panukatan/bagyo/blob/main/data-raw/process_data.R).

The following information is available from the dataset:

**Variable** | **Description** 
:--- | :--- 
*year* | Year 
*category_code* | Tropical cyclone category code
*category_name* | Tropical cyclone category name
*name* | Name given to the tropical cyclone by Philippine authorities
*rsmc_name* | Name given to the tropical cyclone by the Regional Specialized Meteorological Centre (RSMC)
*start* | Date and time at which cyclone enters Philippine area of responsibility (PAR)
*end* | Date and time at which cyclone leaves Philippine area of responsibility (PAR)
*pressure* | Maximum central pressure in *hPa*
*speed* | Maximum sustained wind speed in *km/h*

This metadata can be viewed in R through a call to `?cyclones` in the R console.

Whilst tropical cyclones have affected the Philippines far earlier than 2017 and more currently than 2020, official and publicly available data for the information described above is only available in the reports for years 2017 to 2020. Earlier documents of this annual reporting pre-2017 have been produced but are not available on the [PAGASA](https://www.pagasa.dost.gov.ph/) website. These reports of the tropical cyclone season (re-started in 2019) are published within two years after the termination of the season. Hence, the most recent report is only up to 2020 for now.

It is expected that reports for 2021 onwards will continue to be published and made available by PAGASA. As such, the `bagyo` package and the `cyclones` dataset within it will be updated accordingly. Continued efforts are also being taken to find sources of information for years preceding 2017.

This introductory vignette documents the utility of the `cyclones` dataset in the `bagyo` package in general statistics and data science teaching and for software documentation and testing.

## Data wrangling

Following are some highlight examples of how the `cyclones` dataset can be used to demonstrate various data wrangling approaches, particularly those using the `tidyverse` packages.

### Creating summaries

```{r summary}
library(dplyr)
library(tidyr)

## Get number of cyclone categories per year ----
cyclones |>
  group_by(year, category_name) |>
  count() |>
  group_by(year) |>
  complete(category_name) |>
  ungroup()

## Get yearly mean cyclone pressure and speed ----
cyclones |>
  group_by(year) |>
  summarise(mean_pressure = mean(pressure), mean_speed = mean(speed))

## Get cyclone category mean pressure and speed ----
cyclones |>
  group_by(category_name) |>
  summarise(
    n = n(),
    mean_pressure = mean(pressure), 
    mean_speed = mean(speed)
  )
```

### Working with date and time data

```{r working-with-dates}
library(lubridate)

## Get cyclone category mean duration (in hours) ----
cyclones |>
  mutate(duration = end - start) |>
  group_by(category_name) |>
  summarise(mean_duration = mean(duration))

## Get number of cyclones per month by year ----
cyclones |>
  mutate(month = month(start, label = TRUE)) |>
  group_by(month, year) |>
  count() |>
  ungroup() |>
  complete(month, year, fill = list(n = 0)) |>
  arrange(year, month)
```

## Data visualisation

### Bar plots

```{r barplot, echo = FALSE, fig.align = "center", fig.height = 4}
library(ggplot2)

## Get cyclone category mean duration (in hours) ----
cyclones |>
  mutate(duration = end - start) |>
  group_by(category_name) |>
  summarise(mean_duration = mean(duration)) |>
  ggplot(mapping = aes(x = mean_duration, y = category_name)) +
  geom_col(fill = alpha("#4b876e", 0.7)) +
  labs(
    title = "Mean duration of cyclones",
    subtitle = "By cyclone categories",
    x = "mean duration (hours)",
    y = NULL
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()
  )
```

### Scatter plots

```{r scatterplot, echo = FALSE, fig.align = "center", fig.height = 5, fig.width = 8}
## Cyclone speed by presssure ----
cyclones |>
  dplyr::mutate(year = factor(year)) |>
  ggplot(mapping = aes(x = speed, y = pressure)) +
  geom_point(mapping = aes(colour = category_name), size = 3, alpha = 0.7) +
  scale_colour_manual(
    name = NULL,
    values = c("#9c5e60", "#4b876e", "#465b92", "#e5be72", "#5d0505")
  ) +
  labs(
    title = "Cyclone maximum sustained wind speed and maximum central pressure",
    subtitle = "By cyclone categories and year",
    x = "wind speed (km/h)",
    y = "central pressure (hPa)"
  ) +
  facet_wrap(. ~ year, ncol = 4) +
  theme_bw() +
  theme(
    legend.position = "top",
    strip.background = element_rect(
      fill = alpha("#465b92", 0.7), colour = "#465b92"
    ),
    panel.border = element_rect(colour = "#465b92"),
    panel.grid.minor = element_blank()
  )
```

### Time series

```{r time-series, fig.align = "center", fig.height = 4, fig.width = 8}
## Get number of cyclones per month by year and plot ----
cyclones |>
  mutate(month = month(start, label = TRUE)) |>
  group_by(month, year) |>
  count() |>
  ungroup() |>
  complete(month, year, fill = list(n = 0)) |>
  arrange(year, month) |>
  ggplot(mapping = aes(x = month, y = n)) +
  geom_col(fill = alpha("#4b876e", 0.7)) +
  scale_y_continuous(breaks = seq(from = 0, to = 6, by = 1)) +
  labs(
    title = "Number of cyclones over time",
    subtitle = "2017-2020",
    x = NULL,
    y = "n"
  ) +
  facet_wrap(. ~ year, ncol = 4) +
  theme_bw() +
  theme(
    strip.background = element_rect(
      fill = alpha("#465b92", 0.7), colour = "#465b92"
    ),
    panel.border = element_rect(colour = "#465b92"),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5)
  )
```

### Distribution plots

```{r boxplot, fig.align = "center"}
cyclones |>
  mutate(year = factor(year)) |>
  ggplot(mapping = aes(x = year, y = speed)) +
  geom_boxplot(colour = "#4b876e", fill = alpha("#4b876e", 0.5)) +
  labs(
    title = "Distribution of tropical cyclone maximum sustained wind speed",
    subtitle = "2017-2022",
    x = NULL, y = "speed (km/h)"
  ) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank())
```


```{r boxplot-jitter, fig.align = "center"}
cyclones |>
  mutate(year = factor(year)) |>
  ggplot(mapping = aes(x = year, y = speed)) +
  geom_boxplot(colour = "#4b876e") +
  geom_jitter(
    colour = "#4b876e", fill = alpha("#4b876e", 0.5),
    shape = 21, size = 2, width = 0.2
  ) +
  labs(
    title = "Distribution of tropical cyclone maximum sustained wind speed",
    subtitle = "2017-2022",
    x = NULL, y = "speed (km/h)"
  ) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank())
```

```{r violin-jitter, fig.align = "center"}
cyclones |>
  mutate(year = factor(year)) |>
  ggplot(mapping = aes(x = year, y = speed)) +
  geom_violin(colour = "#4b876e", fill = alpha("#4b876e", 0.5)) +
  geom_jitter(colour = "#4b876e", size = 2, width = 0.2) +
  labs(
    title = "Distribution of tropical cyclone maximum sustained wind speed",
    subtitle = "2017-2022",
    x = NULL, y = "speed (km/h)"
  ) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank())
```
